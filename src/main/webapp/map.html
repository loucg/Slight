<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>地图</title>

<link rel="stylesheet" type="text/css"
	href="static/map/css/jquery-ui-1.10.4.custom.min.css" />
<link rel="stylesheet" type="text/css"
	href="static/map/css/ui.jqgrid.css" />
<link rel="stylesheet" type="text/css"
	href="static/map/css/ui.jqgrid.css" />
<link rel="stylesheet" type="text/css"
	href="static/map/css/admin-all.css" />
<link rel="stylesheet" type="text/css" href="static/map/css/base.css" />
<link rel="stylesheet" type="text/css" href="static/map/css/formui.css" />
<link rel="stylesheet" type="text/css" href="static/map/css/chur.css" />
<link rel="stylesheet" type="text/css"
	href="static/map/css/bootstrap.min.css" />
<script type="text/javascript" src="static/map/js/jquery-1.7.2.js"></script>
<script type="text/javascript"
	src="static/map/js/jquery-ui-1.10.3.custom.min.js"></script>
<script type="text/javascript" src="static/map/js/grid.locale-cn.js"></script>
<script type="text/javascript"
	src="static/map/js/jquery.jqGrid.4.5.2.min.js"></script>
<script type="text/javascript" src="static/map/js/index.js"></script>
<script type="text/javascript"
	src="static/map/js/ChurAlert.min.js?skin=blue"></script>
<script type="text/javascript" src="static/map/js/chur-alert.1.0.js"></script>
<script type="text/javascript" src="static/map/js/mapContent.js"></script>
<script type="text/javascript" src="static/map/js/map.js"></script>
<script type="text/javascript"
	src="http://api.map.baidu.com/api?v=2.0&ak=H0j9w4M81wm8pl1klUsAPQklDddKFqc9">
	
</script>
<script type="text/javascript"
	src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet"
	href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
<style type="text/css">
html {
	height: 100%
}

body {
	height: 100%;
	margin: 0px;
	padding: 0px
}

#container {
	height: 100%
}

.anchorBL {
	display: none
}
</style>
</head>
<body>
	<div id="container"></div>
</body>
<script type="text/javascript">
	var choseMaker;//全局变量很重要////////////////////////////////////////////////////////////////
	var choseMakerdata;//全局变量很重要////////////////////////////////////////////////////////////
	var preMakerdata;//全局变量很重要////////////////////////////////////////////////////////////
	// 定义自定义覆盖物的构造函数  
	function SquareOverlay(center, length, data) {
		this._center = center;
		this._length = length;
		this._data = data;
	}
	// 继承API的BMap.Overlay    
	SquareOverlay.prototype = new BMap.Overlay();
	//实现初始化方法  
	SquareOverlay.prototype.initialize = function(map) {
		// 保存map对象实例   
		this._map = map;
		// 创建div元素，作为自定义覆盖物的容器   
		var div = document.createElement("div");
		div.style.position = "absolute";
		// 可以根据参数设置元素外观   
		div.style.width = this._length + "px";
		div.style.height = this._length + "px";
		var statuscolor;
		var clienttype;

		if ("正常" == this._data.status) {
			statuscolor = "green";
		} else if ("异常" == this._data.status) {
			statuscolor = "red";
		} else if ("断电" == this._data.status) {
			statuscolor = "grey";
		} else {
			statuscolor = "green";
		}
		//clienttype = "light_";
		if ("灯" == this._data.aliastypename) {
			clienttype = "light_";
		} else if ("断路器" == this._data.aliastypename) {
			clienttype = "breaker_";
		} else if ("网关" == this._data.aliastypename) {
			clienttype = "gateway_";
		} else {
			clienttype = "light_";
		}
		var backgroundimage = "url('static/map/img/" + clienttype + statuscolor
				+ ".png')";
		div.style.backgroundImage = backgroundimage;
		// 将div添加到覆盖物容器中   
		map.getPanes().markerPane.appendChild(div);
		/* div.onclick = function() {
		 alert("您点击了标注2");
		 } 
		 div.addEventListener('click', function(e) {
		 //alert('touched');
		 console.log(e);
		 })
		 */

		// 保存div实例   
		this._div = div;
		// 需要将div元素作为方法的返回值，当调用该覆盖物的show、   
		// hide方法，或者对覆盖物进行移除时，API都将操作此元素。   
		return div;
	}
	//实现绘制方法   
	SquareOverlay.prototype.draw = function() {
		// 根据地理坐标转换为像素坐标，并设置给容器    
		var position = this._map.pointToOverlayPixel(this._center);
		this._div.style.left = position.x - this._length / 2 + "px";
		this._div.style.top = position.y - this._length + "px";
	}

	//显示和隐藏覆盖物  
	// 实现显示方法    
	SquareOverlay.prototype.show = function() {
		if (this._div) {
			this._div.style.display = "";
		}
	}
	// 实现隐藏方法    
	SquareOverlay.prototype.hide = function() {
		if (this._div) {
			this._div.style.display = "none";
		}
	}

	//添加其他覆盖物方法  
	SquareOverlay.prototype.hello = function() {
		if (this._div) {
			console.log("hello");
		}
	}

	//自定义覆盖物添加事件方法   
	SquareOverlay.prototype.addEventListener = function(event, fun) {
		this._div['on' + event] = fun;
	}
	////////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////
	////////////////////////////////////////////////////////////////////////////////////////////////////////////
	var map = new BMap.Map("container", {
		//minZoom : 15,
		enableMapClick : false
	});// 创建地图实例   构造底图时，关闭底图可点功能
	//map.centerAndZoom("杭州", 15);// 初始化地图，设置中心点坐标和地图级别
	var top_left_navigation = new BMap.NavigationControl(); //左上角，添加默认缩放平移控件
	map.addControl(top_left_navigation);
	map.enableScrollWheelZoom(true);//启用滚轮放大缩小
	map.setDefaultCursor("url('bird.cur')"); //设置地图默认的鼠标指针样式
	map.disableDoubleClickZoom(true);

	var menu = new BMap.ContextMenu();
	var CircleAndRectangle = null;
	var txtMenuItem = [ {
		text : '需求都没说，放大',
		callback : function() {
			map.zoomIn();
			CircleAndRectangle.removeContextMenu(menu);
			map.removeOverlay(CircleAndRectangle);
			CircleAndRectangle = null;
		}
	}, {
		text : '不要点，缩小',
		callback : function() {
			map.zoomOut();
			CircleAndRectangle.removeContextMenu(menu);
			map.removeOverlay(CircleAndRectangle);
			CircleAndRectangle = null;
		}
	}, {
		text : '清除',
		callback : function() {
			CircleAndRectangle.removeContextMenu(menu);
			map.removeOverlay(CircleAndRectangle);
			CircleAndRectangle = null;
		}
	}  ];
	for (var i = 0; i < txtMenuItem.length; i++) {
		menu.addItem(new BMap.MenuItem(txtMenuItem[i].text,
				txtMenuItem[i].callback, 100));
	}

	var drawingManager = new BMapLib.DrawingManager(map, {
		isOpen : false, //是否开启绘制模式
		enableDrawingTool : true, //是否显示工具栏
		drawingToolOptions : {
			anchor : BMAP_ANCHOR_TOP_RIGHT, //位置
			offset : new BMap.Size(5, 5), //偏离值
			scale : 0.8, //工具栏缩放比例
			drawingModes : [ BMAP_DRAWING_CIRCLE, BMAP_DRAWING_RECTANGLE ]
		}
	//, rectangleOptions: styleOptions //矩形的样式

	});
	drawingManager.addEventListener('circlecomplete', function(e, overlay) {
		//	circlecomplete
		if (CircleAndRectangle != null) {
			CircleAndRectangle.removeContextMenu(menu);
		}
		map.removeOverlay(CircleAndRectangle);
		CircleAndRectangle = overlay;
		overlay.addContextMenu(menu);
		map.addContextMenu(menu);
		map.addOverlay(overlay);
		var radius = parseInt(e.getRadius());
		var center = e.getCenter();
		var bound = e.getBounds();
		judgeSelection(bound);
		drawingManager.close();
	});
	drawingManager.addEventListener('rectanglecomplete', function(e, overlay) {
		//	circlecomplete
		if (CircleAndRectangle != null) {
			CircleAndRectangle.removeContextMenu(menu);
		}
		map.removeOverlay(CircleAndRectangle);
		CircleAndRectangle = overlay;
		overlay.addContextMenu(menu);
		map.addOverlay(overlay);
		//var radius = parseInt(e.getRadius());
		var bound = e.getBounds();
		judgeSelection(bound);
		drawingManager.close();
	});
	//map.addEventListener("click", showInfo);
	function getClientsData(mapTermpage2) {
		$.ajax({
			url : "gomap/addClientMaker",
			type : "POST",
			contentType : "application/json; charset=UTF-8",
			data : JSON.stringify(mapTermpage2),
			dataType : "json",
			success : function(clientdata) {
				if (clientdata != null) {
					preMakerdata = clientdata;
					//console.log(clientdata);
					addClientMaker(clientdata);
				} else {
				}
			},
			error : function() {
				//console.log("1111111");
				//alert('fail');
			}
		});
	}
	//添加覆盖物 
	var infoWindow;//全局变量，相当重要/////////////////////////////////////////////////////
	function addClientMaker(data) {
		for (var i = 0; i < data.length; i++) {
			var markerpoint = new BMap.Point(data[i].xcoordinate,
					data[i].ycoordinate);
			var mySquare = new SquareOverlay(markerpoint, 25, data[i]);
			map.addOverlay(mySquare);
			//8、 为自定义覆盖物添加点击事件      
			(function(k) {
				mySquare.addEventListener('click', function(e) {//这里是自定义覆盖物的事件   
					choseMaker = this;//this.style.backgroundImage = "url('map/img/light_red.png')";
					choseMakerdata = data[k];
					getMakerIconAndInfo(choseMaker, choseMakerdata);/////////////////////////////
					var sContent = getInfoContent(data[k]);
					var opts = {
						width : 304, // 信息窗口宽度
						height : 204, // 信息窗口高度
					};
					infoWindow = new BMap.InfoWindow(sContent, opts); // 创建信息窗口对象      
					map.addEventListener('click', fo);
				});
			}(i));
		}
		var Xcoordinate = 0;
		var Ycoordinate = 0;
		var minXcoordinate = data[0].xcoordinate;
		var minYcoordinate = data[0].ycoordinate;
		var maxXcoordinate = data[0].xcoordinate;
		var maxYcoordinate = data[0].ycoordinate;
		for (var i = 0; i < data.length; i++) {
			Xcoordinate = Xcoordinate + data[i].xcoordinate
			Ycoordinate = Ycoordinate + data[i].ycoordinate
			if (data[i].xcoordinate < minXcoordinate) {
				minXcoordinate = data[i].xcoordinate
			}
			if (data[i].xcoordinate > maxXcoordinate) {
				maxXcoordinate = data[i].xcoordinate
			}
			if (data[i].ycoordinate < minYcoordinate) {
				minYcoordinate = data[i].ycoordinate
			}
			if (data[i].ycoordinate > maxYcoordinate) {
				maxYcoordinate = data[i].ycoordinate
			}

		}
		Xcoordinate = Xcoordinate / data.length;
		Ycoordinate = Ycoordinate / data.length;
		//console.log(Xcoordinate);
		//console.log(Ycoordinate);
		var centerdata = {
			xcoordinate : Xcoordinate,
			ycoordinate : Ycoordinate
		};
		changeZoom(centerdata, minXcoordinate, minYcoordinate, maxXcoordinate,
				maxYcoordinate);//设置zoom大小
		changeCenter(centerdata);//设置中心点
	}

	//叠加层点击事件       
	function fo(e) {
		var point = new BMap.Point(e.point.lng, e.point.lat);
		map.openInfoWindow(infoWindow, point); //开启信息窗口     
		map.removeEventListener("click", fo); //这里取消绑定。                
	}
	//0.5秒后改变地图的展示中心       
	function changeCenter(data) {
		//console.log(data.xcoordinate, data.ycoordinate);
		setTimeout(function() {
			map.panTo(new BMap.Point(data.xcoordinate, data.ycoordinate)); //两秒后移动到第一个点
		}, 500);

	}
	//改变地图的zoom大小    
	function changeZoom(center, minx, miny, maxx, maxy) {
		for (var i = 19; i > 0; i--) {
			map.centerAndZoom(new BMap.Point(center.xcoordinate,
					center.ycoordinate), i);
			var bs = map.getBounds(); //获取可视区域
			var bssw = bs.getSouthWest(); //可视区域左下角
			var bsne = bs.getNorthEast(); //可视区域右上角
			if (bssw.lng < minx && bssw.lat<miny&&bsne.lng>maxx
					&& bsne.lat > maxy)
				break;
			//console.log("当前地图可视范围是：" + bssw.lng + "," + bssw.lat + "到" + bsne.lng + "," + bsne.lat);
			//console.log(i)
		}
	}
	//清除所有覆盖物   
	function cleanAllMaker() {
		map.clearOverlays();
	}
	//得到选择的哪一个点
	function getMakerIconAndInfo(div, data) {
		//console.log(div);
		//console.log(data);
		//infoWindow.setContent(content: String | HTMLElement);
		//infoWindow.redraw()	;

	}
	//改变PreMakerdata，用于searchdata
	function changePreMakerdata(data) {
		preMakerdata=data;
	}
	//判断是否在选择框内
	function judgeSelection(bound) {
		//console.log(preMakerdata.length);
		for(var i=0;i<preMakerdata.length;i++){
			var judgepoint = new BMap.Point(preMakerdata[i].xcoordinate,
					preMakerdata[i].ycoordinate);
			if(bound.containsPoint(judgepoint))
				{
				console.log(preMakerdata[i].id);
				}
			
		}
		
	}
	function TurnOnLight() {
		if (choseMakerdata.status == "正常") {
			$('body').alert({
				type : 'primary',
				title : '提示',
				content : '路灯已开启！',
				btntext : '确定',
				modal : true,
				draggabled : false,
				even : 'click'
			});
		} else {
			$
					.ajax({
						url : "gomap/updateClientAttr_status",
						type : "POST",
						contentType : "application/json; charset=UTF-8",
						data : JSON.stringify(choseMakerdata),
						dataType : "json",
						success : function(data) {
							if (data.status == "SUCCESS") {
								//choseMaker.style.backgroundImage = "url('map/img/light_green.png')";
								cleanAllMaker();//清除所有覆盖物
								var a = parent.getmapTermpagein()[choseMakerdata.termid];
								//console.log(a);
								getClientsData(a);
								$('body').alert({
									type : 'success',
									title : '提示',
									content : '更新成功！',
									modal : true,
									draggabled : false,
									even : 'click',
									buttons : [ {
										id : 'yes',
										name : '确定',
										callback : function() {
										}
									} ]
								});
								//infoWindow.setContent("11111");
								//infoWindow.redraw()	;

							} else {
								$('body').alert({
									type : 'primary',
									title : '提示',
									content : '更新失败！',
									btntext : '确定',
									modal : true,
									draggabled : false,
									even : 'click'
								});
							}

						},
						error : function() {
							$('body').alert({
								type : 'primary',
								title : '提示',
								content : '更新失败！',
								btntext : '确定',
								modal : true,
								draggabled : false,
								even : 'click'
							});
						}

					});

		}

	}
	function TurnOffLight() {
		if (choseMakerdata.status != "正常") {
			$('body').alert({
				type : 'primary',
				title : '提示',
				content : '路灯已关闭！',
				btntext : '确定',
				modal : true,
				draggabled : false,
				even : 'click'
			});
		} else {
			$
					.ajax({
						url : "gomap/updateClientAttr_status",
						type : "POST",
						contentType : "application/json; charset=UTF-8",
						data : JSON.stringify(choseMakerdata),
						dataType : "json",
						success : function(data) {
							if (data.status == "SUCCESS") {
								//choseMaker.style.backgroundImage = "url('map/img/light_grey.png')";
								cleanAllMaker();//清除所有覆盖物
								var a = parent.getmapTermpagein()[choseMakerdata.termid];
								//console.log(a);
								getClientsData(a);
								$('body').alert({
									type : 'success',
									title : '提示',
									content : '更新成功！',
									modal : true,
									draggabled : false,
									even : 'click',
									buttons : [ {
										id : 'yes',
										name : '确定',
										callback : function() {
										}
									} ]
								});

							} else {
								$('body').alert({
									type : 'primary',
									title : '提示',
									content : '更新失败！',
									btntext : '确定',
									modal : true,
									draggabled : false,
									even : 'click'
								});
							}

						},
						error : function() {
							$('body').alert({
								type : 'primary',
								title : '提示',
								content : '更新失败！',
								btntext : '确定',
								modal : true,
								draggabled : false,
								even : 'click'
							});
						}

					});

		}

	}
	function PolicyControl() {
		console.log("PolicyControl");
	}
	function change_bright(bright) {
		choseMakerdata.brightness = bright
		$.ajax({
			url : "gomap/updateClientAttr_brightness",
			type : "POST",
			contentType : "application/json; charset=UTF-8",
			data : JSON.stringify(choseMakerdata),
			dataType : "json",
			success : function(data) {
				if (data.status == "SUCCESS") {
					cleanAllMaker();//清除所有覆盖物
					var a = parent.getmapTermpagein()[choseMakerdata.termid];
					//console.log(a);
					getClientsData(a);
					$('body').alert({
						type : 'success',
						title : '提示',
						content : '更新成功！',
						modal : true,
						draggabled : false,
						even : 'click',
						buttons : [ {
							id : 'yes',
							name : '确定',
							callback : function() {
							}
						} ]
					});

				} else {
					$('body').alert({
						type : 'primary',
						title : '提示',
						content : '更新失败！',
						btntext : '确定',
						modal : true,
						draggabled : false,
						even : 'click'
					});
				}

			},
			error : function() {
				$('body').alert({
					type : 'primary',
					title : '提示',
					content : '更新失败！',
					btntext : '确定',
					modal : true,
					draggabled : false,
					even : 'click'
				});
			}

		});
	}
</script>
<script type="text/javascript">
	jQuery.getJSON("gomap/getFirstTermId/", function(data) {
		if (data != null) {
			//alert(data);
			var mapTermpage2 = {
				page : 1,
				rows : 2,
				begin : 0,
				end : 0,
				havenest : false,
				termid : data
			};
			;
			getClientsData(mapTermpage2);
		} else {
			$('body').alert({
				type : 'primary',
				title : '提示',
				content : '暂无数据！',
				btntext : '确定',
				modal : true,
				draggabled : false,
				even : 'click'
			});
		}
	});

	$(function() {
		//getClientsData(1);
	});
</script>


<script type="text/javascript">
	/* 	var point = new BMap.Point(120.127809, 30.278594);
	 var myIcon = new BMap.Icon("img/light_green.png", new BMap.Size(25, 25), {
	 //offset : new BMap.Size(25, 12)
	 });
	 var marker = new BMap.Marker(point, {
	 icon : myIcon
	 });
	 map.addOverlay(marker);
	 marker.addEventListener("click", function(e) {
	 openInfo("111", e)
	 });

	 var opts = {
	 width : 250, // 信息窗口宽度
	 height : 80, // 信息窗口高度
	 title : "信息窗口", // 信息窗口标题
	 enableMessage : true
	 //设置允许信息窗发送短息
	 };
	 function openInfo(content, e) {
	 var p = e.target;
	 var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
	 //console.log(p.getPosition().lng, p.getPosition().lat);
	 var infoWindow = new BMap.InfoWindow(content, opts); // 创建信息窗口对象 
	 map.openInfoWindow(infoWindow, point); //开启信息窗口
	 } */
</script>
</html>
